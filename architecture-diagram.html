<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TurboTax Modern Microservices Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1350px; 
            margin: 0 auto; 
            background: white; 
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            border-bottom: 4px solid #3498db; 
            padding-bottom: 14px;
            font-size: 2.4em;
            margin-bottom: 28px;
        }
        .mermaid { 
            text-align: center; 
            background: white; 
            padding: 25px;
            border: 2px solid #3498db;
            border-radius: 12px;
            margin: 20px 0;
            height: auto;
            overflow: visible;
            width: calc(100% - 10px);
            box-sizing: border-box;
        }
        
        /* Make entity diagram smaller */
        .mermaid:has([id*="entity"]) {
            transform: scale(0.5);
            transform-origin: top center;
            margin-bottom: -120px;
        }
        
        /* Custom Mermaid styling to fix text cutoff */
        .mermaid svg {
            max-width: 100% !important;
            width: 100% !important;
            height: auto;
        }
        
        .mermaid .node rect {
            min-width: 120px !important;
            min-height: 60px !important;
        }
        
        /* Resize AI Refund ETA Service specifically */
        .mermaid .cluster rect {
            min-width: 200px !important;
            min-height: 100px !important;
        }
        
        .mermaid .nodeLabel {
            font-size: 13px !important;
            font-weight: 600 !important;
        }
        
        .mermaid .node text {
            font-size: 13px !important;
            fill: #000 !important;
        }
        
        /* Make subgraphs larger */
        .mermaid .cluster[id*="AI"] rect {
            min-width: 250px !important;
            min-height: 120px !important;
        }
        
        /* Database node styling */
        .mermaid .node.database {
            fill: #fff8e1 !important;
            stroke: #ff8f00 !important;
            stroke-width: 3px !important;
        }
        
        /* Cross-cutting concerns styling */
        .mermaid .node.crosscutting {
            fill: #f3e5f5 !important;
            stroke: #8e24aa !important;
            stroke-width: 2px !important;
        }
        .description {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
            gap: 22px;
            margin: 28px 0;
        }
        .service-card {
            background: #fff;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            padding: 19px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        .service-card h3 {
            color: #2980b9;
            margin-top: 0;
        }
        .port {
            background: #e74c3c;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
        }
        .endpoint {
            background: #27ae60;
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 13px;
            margin: 3px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TurboTax Modern Microservices Architecture</h1>
        
        <div class="description">
            <p><strong>Overview:</strong> Enterprise-grade TurboTax microservices platform designed for high-performance tax refund processing. The architecture delivers real-time status tracking, intelligent ETA predictions, and seamless integration with external tax authorities and financial institutions.</p>
        </div>

        <div class="mermaid">
graph TB
    User[User/Client Application]
    Gateway[API Gateway]
    
    User --> Gateway
    Gateway --> RQS
    
    subgraph "Core Services"
        RQS["RefundQueryService<br/>Port 8001<br/>Main Entry Point"]
        FDS["FilingQueryService<br/>Port 7001<br/>TaxFiling Records"]
        RAS["RefundAggregationService<br/>Port 7002<br/>External Integration"]
        RPS["RefundPredictionService<br/>Port 7003<br/>ML + Prediction Cache"]
    end
    
    subgraph "Data Layer"
        FilingDB[("Filing Database<br/>TaxFiling Records")]
        RefundDB[("Refund Database<br/>RefundStatusAggregate")]
        ModelDB[("Model Database<br/>PredictionResult")]
        
        subgraph "Caching Layer"
            PredCache["Prediction Cache<br/>TTL: 4h<br/>Cache PredictionResult"]
            ETACache["ETA Cache<br/>TTL: 30m<br/>Cache RefundEtaPrediction"]
            StatusCache["Status Cache<br/>TTL: 4h<br/>Cache RefundStatusData"]
            QueryCache["Query Cache<br/>TTL: 30m<br/>Cache RefundSummary"]
        end
    end
    
    subgraph "External Integrations"
        IRS["IRS API<br/>Real-time Status"]
        StateTax["State Tax APIs<br/>Multi-jurisdiction"]
        BankAPI["Banking APIs<br/>Money Movement"]
    end
    
    subgraph "Event & Messaging"
        Kafka["Kafka Event Broker<br/>Status Change Events"]
        NotificationSvc["Notification Service<br/>User Alerts"]
    end
    
    %% Primary service flow - actual architecture
    RQS --> FDS
    RQS --> RAS
    RQS --> RPS
    
    %% Database connections with modern entities
    FDS --> FilingDB
    RAS --> RefundDB
    RPS --> ModelDB
    
    %% Caching connections - simplified with single arrows
    RPS -.-> PredCache
    RPS -.-> ETACache
    RAS -.-> StatusCache
    RQS -.-> QueryCache
    
    %% External API connections
    RAS --> IRS
    RAS --> StateTax
    RAS --> BankAPI
    
    %% Event-driven architecture
    RAS -->|Status Events| Kafka
    Kafka -->|User Notifications| NotificationSvc
    
    %% Styling for modern architecture
    classDef service fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#000
    classDef database fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    classDef cache fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000
    classDef external fill:#fff8e1,stroke:#fbc02d,stroke-width:2px,color:#000
    classDef event fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#000
    
    class RQS,FDS,RAS,RPS service
    class FilingDB,RefundDB,ModelDB database
    class PredCache,ETACache,StatusCache,QueryCache cache
    class IRS,StateTax,BankAPI external
    class Kafka,NotificationSvc event
        </div>

        <h2>Service Overview</h2>
        <div class="service-grid">
            <div class="service-card">
                <h3>Refund Query Service</h3>
                <div class="port">Port 8001</div>
                <p><strong>Main Entry Point</strong> - Orchestrates refund status queries with intelligent caching</p>
                <div class="endpoint">GET /refund-status/{userId}</div>
                <p><em>Features:</em> TTL-based caching (30m TTL) â€¢ Modern Java records â€¢ Enhanced error handling</p>
                <p><em>Implementation:</em> RefundQueryOrchestrator with comprehensive orchestration and user-level caching</p>
            </div>

            <div class="service-card">
                <h3>Filing Query Service</h3>
                <div class="port">Port 7001</div>
                <p><strong>Filing Information</strong> - Provides tax filing information with modern record structures</p>
                <div class="endpoint">GET /filing-info/{userId}</div>
                <p><em>Data Store:</em> Filing Database with optimized queries</p>
                <p><em>Implementation:</em> FilingQueryServiceImpl with TaxFiling record entities</p>
            </div>

            <div class="service-card">
                <h3>Refund Aggregation Service</h3>
                <div class="port">Port 7002</div>
                <p><strong>External Integration</strong> - Multi-source aggregation with intelligent caching</p>
                <div class="endpoint">GET /aggregate-status/{filingId}</div>
                <p><em>Data Store:</em> Refund Database + TTL-based InMemoryCache (4h TTL)</p>
                <p><em>Implementation:</em> RefundDataAggregatorImpl with RefundStatusAggregate records</p>
            </div>

            <div class="service-card">
                <h3>Refund Prediction Service</h3>
                <div class="port">Port 7003</div>
                <p><strong>ML Predictions</strong> - AI-powered ETA predictions with result caching</p>
                <div class="endpoint">GET /refund-eta/{filingId}</div>
                <p><em>Data Store:</em> Model Database + Dual Cache Strategy (4h + 30m TTL)</p>
                <p><em>Implementation:</em> RefundEtaPredictorImpl with two-tier caching (PredictionResult + ETA)</p>
            </div>
        </div>

        <h2>Modern Data Entities</h2>
        <div class="service-grid">
            <div class="service-card">
                <h3>ðŸ“‹ TaxFiling (Record)</h3>
                <p><strong>Type:</strong> Immutable Java Record</p>
                <p><strong>Purpose:</strong> Central tax filing data with compile-time guarantees</p>
                <p><strong>Fields:</strong> filingId(int), taxYear(int), jurisdiction, refundAmount, filingDate, disbursementMethod</p>
            </div>

            <div class="service-card">
                <h3>ðŸ”„ RefundStatusAggregate (Record)</h3>
                <p><strong>Type:</strong> Immutable Java Record</p>
                <p><strong>Purpose:</strong> Consolidated refund status from multiple sources</p>
                <p><strong>Fields:</strong> filingId(int), trackingId, jurisdiction, status, rawStatusCode, messageKey, lastUpdatedAt, amount</p>
            </div>

            <div class="service-card">
                <h3>ðŸ“Š PredictionResult (Record)</h3>
                <p><strong>Type:</strong> Immutable Java Record</p>
                <p><strong>Purpose:</strong> ML model outputs with metadata</p>
                <p><strong>Fields:</strong> expectedDays(double), confidence(double), modelVersion(String)</p>
            </div>

            <div class="service-card">
                <h3>ðŸ“ˆ RefundEtaPrediction (Record)</h3>
                <p><strong>Type:</strong> Immutable Java Record</p>
                <p><strong>Purpose:</strong> User-facing prediction results</p>
                <p><strong>Fields:</strong> expectedDate, confidence, windowDays</p>
            </div>
        </div>

        <h2>Intelligent Caching Architecture</h2>
        <div class="description">
            <p><strong>Multi-Tier Caching Strategy:</strong> Custom Cache interface implementation with TTL support across all prediction services</p>
            
            <div class="service-grid">
                <div class="service-card">
                    <h3>ðŸ§  Prediction Result Cache</h3>
                    <ul>
                        <li><strong>TTL:</strong> 4 hours for ML model predictions</li>
                        <li><strong>Cache Key:</strong> Stable hash of feature vectors</li>
                        <li><strong>Conditional Caching:</strong> Only cache high-confidence results (â‰¥ 0.5)</li>
                        <li><strong>Memory Management:</strong> Automatic cleanup every 30 minutes</li>
                    </ul>
                </div>

                <div class="service-card">
                    <h3>ðŸ“Š ETA Prediction Cache</h3>
                    <ul>
                        <li><strong>TTL:</strong> 30 minutes for user-facing predictions</li>
                        <li><strong>Cache Key:</strong> Filing ID based for user queries</li>
                        <li><strong>Performance:</strong> Reduces redundant ML computations</li>
                        <li><strong>Consistency:</strong> Balances freshness with performance</li>
                    </ul>
                </div>

                <div class="service-card">
                    <h3>ðŸ“‹ Status Data Cache</h3>
                    <ul>
                        <li><strong>TTL:</strong> 4 hours for aggregated status data</li>
                        <li><strong>Cache Key:</strong> Filing ID for refund status aggregation</li>
                        <li><strong>External APIs:</strong> Reduces calls to IRS, State Tax, Banking APIs</li>
                        <li><strong>Multi-jurisdiction:</strong> Caches federal and state status together</li>
                    </ul>
                </div>

                <div class="service-card">
                    <h3>ðŸŽ¯ Query Summary Cache</h3>
                    <ul>
                        <li><strong>TTL:</strong> 30 minutes for orchestrated summaries</li>
                        <li><strong>Cache Key:</strong> User ID for complete refund summaries</li>
                        <li><strong>Orchestration:</strong> Caches complete user experience data</li>
                        <li><strong>Performance:</strong> Reduces cross-service calls for user queries</li>
                    </ul>
                </div>
            </div>
        </div>

        <h2>Business Process Flow</h2>
        <div class="description">
            <p><strong>How entities interact throughout the refund lifecycle</strong></p>
            
            <div class="service-grid">
                <div class="service-card">
                    <h3>ðŸ”„ Primary Data Flow</h3>
                    <ol>
                        <li><strong>User Registration:</strong> User entity created with identity verification</li>
                        <li><strong>Tax Filing:</strong> FilingMetadata entity captures return details</li>
                        <li><strong>Status Tracking:</strong> RefundStatus entity monitors processing progress</li>
                        <li><strong>Feature Engineering:</strong> AiFeatures entity extracts ML-ready data</li>
                        <li><strong>ETA Prediction:</strong> ModelOutput entity stores AI predictions</li>
                    </ol>
                </div>

                <div class="service-card">
                    <h3>âš¡ Real-Time Updates</h3>
                    <ul>
                        <li><strong>User Queries:</strong> Instant access to current refund status</li>
                        <li><strong>External API Sync:</strong> Live updates from IRS and state systems</li>
                        <li><strong>ML Inference:</strong> On-demand ETA predictions for active refunds</li>
                        <li><strong>Cache Strategy:</strong> Smart caching based on refund finality</li>
                    </ul>
                </div>

                <div class="service-card">
                    <h3>ðŸ“ˆ Analytics & Insights</h3>
                    <ul>
                        <li><strong>Historical Analysis:</strong> Filing patterns and seasonal trends</li>
                        <li><strong>Performance Metrics:</strong> Prediction accuracy and model drift</li>
                        <li><strong>Business Intelligence:</strong> Processing bottlenecks and optimization opportunities</li>
                        <li><strong>Customer Insights:</strong> User behavior and satisfaction indicators</li>
                    </ul>
                </div>
            </div>
        </div>

        <h2>Real-Time Flow (User-Initiated)</h2>
        <div class="description">
            <p><strong>Interactive Refund Status Queries:</strong> Real-time processing of user requests for current refund status</p>
            
            <div class="service-card">
                <h3>ðŸ”„ Processing Flow</h3>
                <ol>
                    <li><strong>User Request:</strong> Client application requests refund status via API Gateway</li>
                    <li><strong>Orchestration:</strong> Refund Status Service coordinates the entire workflow</li>
                    <li><strong>Filing Lookup:</strong> Gets user's latest filing information from Filing Metadata Service</li>
                    <li><strong>Status Aggregation:</strong> Fetches refund status from cache or external systems via Aggregator</li>
                    <li><strong>ETA Prediction:</strong> AI service predicts delivery timeframes using ML models</li>
                    <li><strong>Response Assembly:</strong> Orchestrator combines all data into comprehensive RefundSummaryInfo</li>
                </ol>
            </div>

            <div class="service-card">
                <h3>âš¡ Performance Characteristics</h3>
                <ul>
                    <li><strong>Response Time:</strong> < 500ms for cached data</li>
                    <li><strong>Cache Hit Rate:</strong> 85-90% for frequently queried refunds</li>
                    <li><strong>Concurrent Users:</strong> Supports 10,000+ concurrent requests</li>
                    <li><strong>Reactive Processing:</strong> Non-blocking I/O with WebFlux</li>
                </ul>
            </div>

            <div class="service-card">
                <h3>ðŸŽ¯ Service Coordination</h3>
                <ul>
                    <li><strong>Orchestrator Pattern:</strong> Central coordination of all service calls</li>
                    <li><strong>Parallel Processing:</strong> Simultaneous calls to independent services</li>
                    <li><strong>Circuit Breakers:</strong> Fault tolerance for external API failures</li>
                    <li><strong>Graceful Degradation:</strong> Partial responses when services are unavailable</li>
                </ul>
            </div>
        </div>

        <h2>Data Architecture</h2>
        <div class="description">
            <p><strong>Database per Service Pattern:</strong> Each microservice maintains its own dedicated database</p>
            <ul>
                <li><strong>Filing Database:</strong> Stores tax filing metadata, user information, filing status</li>
                <li><strong>Refund Database:</strong> Stores refund status data, aggregated information from external sources</li>
                <li><strong>Model Database:</strong> Stores ML model parameters, training data, feature vectors for ETA predictions</li>
                <li><strong>Cache Layer:</strong> Redis/In-memory cache for performance optimization in the aggregate service</li>
            </ul>
        </div>

        <h2>Data Architecture Patterns</h2>
        <div class="description">
            <p><strong>Database per Service:</strong> Each microservice maintains its own dedicated database with specific entity ownership</p>
            
            <div class="service-grid">
                <div class="service-card">
                    <h3>ðŸ“Š Filing Database</h3>
                    <ul>
                        <li><strong>Entities:</strong> TaxFilingEntity</li>
                        <li><strong>Access Pattern:</strong> Read-heavy with seasonal spikes</li>
                        <li><strong>Scaling:</strong> Read replicas during tax season</li>
                        <li><strong>Repository:</strong> TaxFilingRepository with userId-based queries</li>
                    </ul>
                </div>

                <div class="service-card">
                    <h3>ðŸ’¾ Refund Database</h3>
                    <ul>
                        <li><strong>Entities:</strong> RefundStatusAggregate, RefundStatusData</li>
                        <li><strong>Caching:</strong> TTL-based InMemoryCache with 4h expiration</li>
                        <li><strong>External Clients:</strong> IRS API, State Tax APIs, Money Movement APIs</li>
                        <li><strong>Data Flow:</strong> Multi-source aggregation with real-time status updates</li>
                    </ul>
                </div>

                <div class="service-card">
                    <h3>ðŸ§  Prediction Database</h3>
                    <ul>
                        <li><strong>Entities:</strong> RefundPredictionFeature, PredictionResult</li>
                        <li><strong>Features:</strong> Categorical and numeric features for ML processing</li>
                        <li><strong>Predictions:</strong> Cached ML model outputs with confidence scores</li>
                        <li><strong>Performance:</strong> Optimized for real-time inference with TTL caching</li>
                    </ul>
                </div>
            </div>
        </div>

        <h2>Cross-Cutting Concerns</h2>
        <div class="service-grid">
            <div class="service-card">
                <h3>Security & Auth</h3>
                <ul>
                    <li>Authentication & Authorization</li>
                    <li>JWT Token Management</li>
                    <li>API Security</li>
                    <li>Data Encryption</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Centralized Logging</h3>
                <ul>
                    <li>Structured Logging</li>
                    <li>Log Aggregation</li>
                    <li>Log Correlation</li>
                    <li>Error Tracking</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Monitoring & Metrics</h3>
                <ul>
                    <li>Application Metrics</li>
                    <li>Performance Monitoring</li>
                    <li>Health Checks</li>
                    <li>Alerting</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Configuration Management</h3>
                <ul>
                    <li>Environment Configuration</li>
                    <li>Feature Flags</li>
                    <li>Dynamic Configuration</li>
                    <li>Secrets Management</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Distributed Tracing</h3>
                <ul>
                    <li>Request Tracing</li>
                    <li>Performance Analysis</li>
                    <li>Service Dependency Mapping</li>
                    <li>Latency Tracking</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                nodeSpacing: 85,
                rankSpacing: 75,
                padding: 15
            },
            er: {
                useMaxWidth: true,
                fontSize: '8px',
                layoutDirection: 'TB'
            },
            themeVariables: {
                fontSize: '13px',
                fontFamily: 'Arial, sans-serif',
                primaryColor: '#fff3e0',
                primaryTextColor: '#000',
                primaryBorderColor: '#f57c00',
                lineColor: '#333',
                secondaryColor: '#e1f5fe',
                tertiaryColor: '#f3e5f5'
            }
        });
    </script>
</body>
</html>