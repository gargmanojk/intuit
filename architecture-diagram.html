<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TurboTax Microservices Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1350px; 
            margin: 0 auto; 
            background: white; 
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            border-bottom: 4px solid #3498db; 
            padding-bottom: 14px;
            font-size: 2.4em;
            margin-bottom: 28px;
        }
        .mermaid { 
            text-align: center; 
            background: white; 
            padding: 25px;
            border: 2px solid #3498db;
            border-radius: 12px;
            margin: 20px 0;
            height: auto;
            overflow: visible;
            width: calc(100% - 10px);
            box-sizing: border-box;
        }
        
        /* Custom Mermaid styling to fix text cutoff */
        .mermaid svg {
            max-width: 100% !important;
            width: 100% !important;
            height: auto;
        }
        
        .mermaid .node rect {
            min-width: 120px !important;
            min-height: 60px !important;
        }
        
        /* Resize AI Refund ETA Service specifically */
        .mermaid .cluster rect {
            min-width: 200px !important;
            min-height: 100px !important;
        }
        
        .mermaid .nodeLabel {
            font-size: 13px !important;
            font-weight: 600 !important;
        }
        
        .mermaid .node text {
            font-size: 13px !important;
            fill: #000 !important;
        }
        
        /* Make subgraphs larger */
        .mermaid .cluster[id*="AI"] rect {
            min-width: 250px !important;
            min-height: 120px !important;
        }
        
        /* Database node styling */
        .mermaid .node.database {
            fill: #fff8e1 !important;
            stroke: #ff8f00 !important;
            stroke-width: 3px !important;
        }
        
        /* Cross-cutting concerns styling */
        .mermaid .node.crosscutting {
            fill: #f3e5f5 !important;
            stroke: #8e24aa !important;
            stroke-width: 2px !important;
        }
        .description {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
            gap: 22px;
            margin: 28px 0;
        }
        .service-card {
            background: #fff;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            padding: 19px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        .service-card h3 {
            color: #2980b9;
            margin-top: 0;
        }
        .port {
            background: #e74c3c;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
        }
        .endpoint {
            background: #27ae60;
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 13px;
            margin: 3px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TurboTax Microservices Architecture</h1>
        
        <div class="description">
            <p><strong>Overview:</strong> This diagram shows the TurboTax microservices architecture with 6 services and external integrations.</p>
        </div>

        <div class="mermaid">
graph TB
    User[User/Client Application]
    Gateway[API Gateway]
    
    User --> Gateway
    Gateway --> RSS
    
    subgraph Services
        RSS[RefundStatusService]
        RSO[RefundStatusOrchestrator]
        FMS[FilingMetadataService]
        RSA[RefundStatusAggregator]
        AES[AiRefundEtaService]
        NS[NotificationService]
        
        FilingDB[(Filing Database)]
        RefundDB[(Refund Database)]
        ModelDB[(Model Database)]
        NotificationDB[(Notification Database)]
        Cache[Cache Layer]
    end
    
    subgraph "Batch Processing Flow"
        Scheduler[Batch Scheduler]
        BatchTrigger[Batch Trigger]
        PendingQuery[Pending Query Engine]
        RBS[RefundStatusBatchProcessor]
        BulkProcessor[Bulk Processor]
    end
    
    subgraph "Notification Channels"
        EmailGW[Email Gateway]
        SMSGW[SMS Gateway]
    end
    
    subgraph External
        IRS[IRS API]
        StateTax[State Tax API]
        MoneyMvmt[Money Movement API]
    end
    
    subgraph Events
        Kafka[Kafka Event Broker]
    end
    
    %% Real-time service connections
    RSS --> RSO
    RSO --> FMS
    RSO --> RSA
    RSO --> AES
    
    %% Batch processing flow
    Scheduler --> BatchTrigger
    BatchTrigger --> PendingQuery
    PendingQuery --> RBS
    RBS --> BulkProcessor
    BulkProcessor --> RSA
    
    %% Database connections
    FMS --> FilingDB
    RSA --> RefundDB
    AES --> ModelDB
    NS --> NotificationDB
    RSA --> Cache
    PendingQuery --> RefundDB
    
    %% External API connections
    RSA --> IRS
    RSA --> StateTax
    RSA --> MoneyMvmt
    
    %% Event connections with labels
    RSA -->|status-update-event| Kafka
    Kafka -->|status-update-event| NS
    
    %% Notification delivery
    NS --> EmailGW
    NS --> SMSGW
    
    %% Styling
    classDef service fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef database fill:#fff8e1,stroke:#ff8f00,stroke-width:2px
    classDef external fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef event fill:#fce4ec,stroke:#e91e63,stroke-width:2px
    classDef batch fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef notification fill:#fff8e1,stroke:#f57c00,stroke-width:2px
    
    class RSS,RSO,FMS,RSA,AES,NS service
    class FilingDB,RefundDB,ModelDB,NotificationDB database
    class IRS,StateTax,MoneyMvmt external
    class Kafka event
    class Scheduler,BatchTrigger,PendingQuery,RBS,BulkProcessor batch
    class EmailGW,SMSGW notification
        </div>

        <h2>Service Overview</h2>
        <div class="service-grid">
            <div class="service-card">
                <h3>Refund Status Service</h3>
                <div class="port">Port 8001</div>
                <p><strong>Main Entry Point</strong> - Orchestrates refund status workflow</p>
                <div class="endpoint">GET /refund-status</div>
                <p><em>Dependencies:</em> All other services</p>
                <p><em>Cross-cutting:</em> Security, Logging, Monitoring, Tracing</p>
            </div>

            <div class="service-card">
                <h3>Filing Metadata Service</h3>
                <div class="port">Port 7001</div>
                <p><strong>Filing Information</strong> - Manages tax filing metadata</p>
                <div class="endpoint">GET /filing-status/{userId}</div>
                <p><em>Data Store:</em> Filing Database</p>
                <p><em>Returns:</em> FilingInfo objects</p>
            </div>

            <div class="service-card">
                <h3>Refund Aggregate Service</h3>
                <div class="port">Port 7002</div>
                <p><strong>External Integration</strong> - Aggregates from IRS, State APIs</p>
                <div class="endpoint">GET /aggregate-status/{filingId}</div>
                <p><em>Data Store:</em> Refund Database + Cache</p>
                <p><em>Features:</em> Caching, Multi-source aggregation</p>
            </div>

            <div class="service-card">
                <h3>AI Refund ETA Service</h3>
                <div class="port">Port 7003</div>
                <p><strong>ML Predictions</strong> - AI-powered ETA predictions</p>
                <div class="endpoint">GET /refund-eta</div>
                <p><em>Data Store:</em> Model Database</p>
                <p><em>Technology:</em> Machine Learning models</p>
            </div>

            <div class="service-card">
                <h3>Refund Status Batch Processor</h3>
                <div class="port">Port 7004</div>
                <p><strong>Batch Processing</strong> - Periodic status updates for pending refunds</p>
                <div class="endpoint">POST /batch/trigger</div>
                <div class="endpoint">GET /batch/status</div>
                <div class="endpoint">GET /batch/metrics</div>
                <p><em>Schedule:</em> Every 2-6 hours (seasonal)</p>
                <p><em>Features:</em> Rate limiting, retry logic, progress tracking</p>
            </div>

            <div class="service-card">
                <h3>Notification Service</h3>
                <div class="port">Event Consumer</div>
                <p><strong>Event-Driven Notifications</strong> - Kafka consumer for status changes</p>
                <p><em>Architecture:</em> Kafka consumer (not web service)</p>
                <p><em>Channels:</em> Email Gateway, SMS Gateway</p>
                <p><em>Features:</em> Dead letter queue, retry logic, delivery tracking</p>
            </div>
        </div>

        <h2>Cross-Cutting Concerns</h2>
        <div class="service-grid">
            <div class="service-card">
                <h3>Security & Auth</h3>
                <ul>
                    <li>Authentication & Authorization</li>
                    <li>JWT Token Management</li>
                    <li>API Security</li>
                    <li>Data Encryption</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Centralized Logging</h3>
                <ul>
                    <li>Structured Logging</li>
                    <li>Log Aggregation</li>
                    <li>Log Correlation</li>
                    <li>Error Tracking</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Monitoring & Metrics</h3>
                <ul>
                    <li>Application Metrics</li>
                    <li>Performance Monitoring</li>
                    <li>Health Checks</li>
                    <li>Alerting</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Configuration Management</h3>
                <ul>
                    <li>Environment Configuration</li>
                    <li>Feature Flags</li>
                    <li>Dynamic Configuration</li>
                    <li>Secrets Management</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Distributed Tracing</h3>
                <ul>
                    <li>Request Tracing</li>
                    <li>Performance Analysis</li>
                    <li>Service Dependency Mapping</li>
                    <li>Latency Tracking</li>
                </ul>
            </div>
        </div>

        <h2>Data Architecture</h2>
        <div class="description">
            <p><strong>Database per Service Pattern:</strong> Each microservice maintains its own dedicated database</p>
            <ul>
                <li><strong>Filing Database:</strong> Stores tax filing metadata, user information, filing status</li>
                <li><strong>Refund Database:</strong> Stores refund status data, aggregated information from external sources</li>
                <li><strong>Model Database:</strong> Stores ML model parameters, training data, feature vectors for ETA predictions</li>
                <li><strong>Cache Layer:</strong> Redis/In-memory cache for performance optimization in the aggregate service</li>
            </ul>
        </div>

        <h2>Real-Time Flow (User-Initiated)</h2>
        <div class="description">
            <p><strong>Interactive Refund Status Queries:</strong> Real-time processing of user requests for current refund status</p>
            
            <div class="service-card">
                <h3>üîÑ Processing Flow</h3>
                <ol>
                    <li><strong>User Request:</strong> Client application requests refund status via API Gateway</li>
                    <li><strong>Orchestration:</strong> Refund Status Service coordinates the entire workflow</li>
                    <li><strong>Filing Lookup:</strong> Gets user's latest filing information from Filing Metadata Service</li>
                    <li><strong>Status Aggregation:</strong> Fetches refund status from cache or external systems via Aggregator</li>
                    <li><strong>ETA Prediction:</strong> AI service predicts delivery timeframes using ML models</li>
                    <li><strong>Response Assembly:</strong> Orchestrator combines all data into comprehensive RefundSummaryInfo</li>
                </ol>
            </div>

            <div class="service-card">
                <h3>‚ö° Performance Characteristics</h3>
                <ul>
                    <li><strong>Response Time:</strong> < 500ms for cached data</li>
                    <li><strong>Cache Hit Rate:</strong> 85-90% for frequently queried refunds</li>
                    <li><strong>Concurrent Users:</strong> Supports 10,000+ concurrent requests</li>
                    <li><strong>Reactive Processing:</strong> Non-blocking I/O with WebFlux</li>
                </ul>
            </div>

            <div class="service-card">
                <h3>üéØ Service Coordination</h3>
                <ul>
                    <li><strong>Orchestrator Pattern:</strong> Central coordination of all service calls</li>
                    <li><strong>Parallel Processing:</strong> Simultaneous calls to independent services</li>
                    <li><strong>Circuit Breakers:</strong> Fault tolerance for external API failures</li>
                    <li><strong>Graceful Degradation:</strong> Partial responses when services are unavailable</li>
                </ul>
            </div>
        </div>

        <h2>Batch Processing Flow</h2>
        <div class="description">
            <p><strong>Automated Refund Status Updates:</strong> 9-step batch processing workflow ensures all pending refunds are regularly updated</p>
            
            <div class="service-card">
                <h3>üïê Processing Schedule</h3>
                <ul>
                    <li><strong>Peak Season (Jan-Apr):</strong> Every 2 hours</li>
                    <li><strong>Off Season (May-Dec):</strong> Every 6 hours</li>
                    <li><strong>Emergency Processing:</strong> On-demand manual trigger</li>
                </ul>
            </div>

            <div class="service-card">
                <h3>‚öôÔ∏è Complete Processing Workflow (9 Steps)</h3>
                <ol>
                    <li><strong>Batch Scheduler:</strong> Cron scheduler triggers batch processing job</li>
                    <li><strong>Batch Trigger:</strong> Activates batch processing workflow and initializes job context</li>
                    <li><strong>Pending Query Engine:</strong> Queries RefundDB for all pending refunds requiring status updates</li>
                    <li><strong>RefundStatusBatchProcessor:</strong> Processes pending refunds and prepares bulk update requests</li>
                    <li><strong>Bulk Processor:</strong> Optimizes and batches requests for efficient API processing</li>
                    <li><strong>RefundStatusAggregator:</strong> Handles bulk calls to external APIs (IRS, State Tax, Money Movement)</li>
                    <li><strong>Event Publishing:</strong> Aggregator publishes status change events to Kafka with labeled status-update-events</li>
                    <li><strong>Notification Processing:</strong> NotificationService consumes Kafka events and sends multi-channel notifications</li>
                    <li><strong>Metrics Collection:</strong> Batch processor records processing statistics, performance metrics, and error tracking</li>
                </ol>
            </div>

            <div class="service-card">
                <h3>üìä Key Features</h3>
                <ul>
                    <li><strong>Rate Limiting:</strong> Respects external API rate limits</li>
                    <li><strong>Retry Logic:</strong> Exponential backoff for failed requests</li>
                    <li><strong>Error Handling:</strong> Comprehensive error tracking and recovery</li>
                    <li><strong>Progress Tracking:</strong> Real-time batch job status monitoring</li>
                    <li><strong>Performance Metrics:</strong> Processing time and throughput analytics</li>
                </ul>
            </div>
        </div>

        <h2>Event-Driven Notification Flow</h2>
        <div class="description">
            <p><strong>Asynchronous Notification System:</strong> Kafka-based event consumption for real-time status notifications</p>
            
            <div class="service-card">
                <h3>üì° Event Processing Architecture</h3>
                <ul>
                    <li><strong>Event Publisher:</strong> RefundStatusAggregator publishes to Kafka topic 'refund-status-events'</li>
                    <li><strong>Event Consumer:</strong> NotificationServiceImpl (Kafka consumer group: 'notification-service-group')</li>
                    <li><strong>Event Flow:</strong> Status changes ‚Üí Kafka events ‚Üí Notification processing ‚Üí Multi-channel delivery</li>
                    <li><strong>Auto-commit:</strong> Disabled (manual commit after successful delivery)</li>
                </ul>
            </div>

            <div class="service-card">
                <h3>üîÑ Notification Processing Steps</h3>
                <ol>
                    <li><strong>Event Consumption:</strong> NotificationService polls Kafka topic for refund status events</li>
                    <li><strong>Event Deserialization:</strong> Parses event payload (userId, refundId, status, timestamp)</li>
                    <li><strong>User Preference Lookup:</strong> Queries NotificationDB for user notification settings</li>
                    <li><strong>Template Selection:</strong> Chooses message template based on refund status and preferences</li>
                    <li><strong>Multi-Channel Delivery:</strong> Sends via Email Gateway and/or SMS Gateway</li>
                    <li><strong>Delivery Tracking:</strong> Records delivery status and handles failures with retry logic</li>
                    <li><strong>Offset Commit:</strong> Manual commit to Kafka after successful processing</li>
                    <li><strong>Dead Letter Queue:</strong> Failed events after retries sent to DLQ for investigation</li>
                </ol>
            </div>

            <div class="service-card">
                <h3>üöÄ Notification Features</h3>
                <ul>
                    <li><strong>Multi-Channel:</strong> Email Gateway (SMTP) + SMS Gateway (Twilio/AWS SNS)</li>
                    <li><strong>Template Management:</strong> Dynamic message templates with personalization</li>
                    <li><strong>Rate Limiting:</strong> Prevents notification spam per user</li>
                    <li><strong>Retry Logic:</strong> Exponential backoff for failed deliveries</li>
                    <li><strong>Delivery Audit:</strong> Complete tracking of success/failure with metrics</li>
                    <li><strong>Event Types:</strong> Refund approved, delayed, sent, processing errors</li>
                </ul>
            </div>
        </div>

        <h2>Technology Stack</h2>
        <div class="service-grid">
            <div class="service-card">
                <h3>Backend</h3>
                <ul>
                    <li>Spring Boot 3.5.0</li>
                    <li>WebFlux (Reactive)</li>
                    <li>Java 24</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Event Streaming</h3>
                <ul>
                    <li>Apache Kafka</li>
                    <li>Event-Driven Architecture</li>
                    <li>Asynchronous Processing</li>
                    <li>Consumer Groups</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Build & Deploy</h3>
                <ul>
                    <li>Gradle (Multi-module)</li>
                    <li>Actuator Health Checks</li>
                    <li>Centralized Logging</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Communication</h3>
                <ul>
                    <li>REST APIs</li>
                    <li>JSON Payloads</li>
                    <li>HTTP/HTTPS</li>
                    <li>Kafka Events</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Notifications</h3>
                <ul>
                    <li>Email Gateway (SMTP)</li>
                    <li>SMS Gateway (Twilio)</li>
                    <li>Multi-channel Delivery</li>
                    <li>Template Management</li>
                </ul>
            </div>
            <div class="service-card">
                <h3>Patterns</h3>
                <ul>
                    <li>Service Orchestration</li>
                    <li>API Gateway</li>
                    <li>Event-Driven Architecture</li>
                    <li>Database per Service</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                nodeSpacing: 85,
                rankSpacing: 75,
                padding: 15
            },
            themeVariables: {
                fontSize: '13px',
                fontFamily: 'Arial, sans-serif',
                primaryColor: '#fff3e0',
                primaryTextColor: '#000',
                primaryBorderColor: '#f57c00',
                lineColor: '#333',
                secondaryColor: '#e1f5fe',
                tertiaryColor: '#f3e5f5'
            }
        });
    </script>
</body>
</html>