// Root build.gradle for TurboTax services

// Individual service tasks
task FilingQueryService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-filing-query-service in background'
    
    commandLine './gradlew', ':turbotax-filing-query-service:bootRun'
    
    doLast {
        println "Started turbotax-filing-query-service"
        println "Service available at http://localhost:7001"
    }
}

task runRefundAggregationService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-refund-aggregation-service in background'
    
    commandLine './gradlew', ':turbotax-refund-aggregation-service:bootRun'
    
    doLast {
        println "Started turbotax-refund-aggregation-service"
        println "Service available at http://localhost:7002"
    }
}

task runRefundQueryService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-refund-query-service in background'
    
    commandLine './gradlew', ':turbotax-refund-query-service:bootRun'
    
    doLast {
        println "Started turbotax-refund-query-service"
        println "Service available at http://localhost:8001"
    }
}

task runAgentService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-agent-service in background'
    
    workingDir 'turbotax-agent-service'
    commandLine './venv/bin/uvicorn', 'turbotax.agent.main:app', '--host', '0.0.0.0', '--port', '9001', '--reload', '--reload-dir', 'src/main/python'
    
    doLast {
        println "Started turbotax-agent-service"
        println "Service available at http://localhost:9001"
    }
}


// Background service tasks (using ProcessBuilder for true background execution)
task startFilingQueryService {
    group = 'services'
    description = 'Starts turbotax-filing-query-service in background (detached)'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        def processBuilder = new ProcessBuilder('./gradlew', ':turbotax-filing-query-service:bootRun')
        processBuilder.directory(file('.'))
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/turbotax-filing-query-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/turbotax-filing-query-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-filing-query-service in background (PID: ${process.pid()})"
        println "Service available at http://localhost:7001"
        println "Logs: logs/turbotax-filing-query-service.log"
    }
}

task startRefundAggregationService {
    group = 'services'
    description = 'Starts turbotax-refund-aggregation-service in background (detached)'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        def processBuilder = new ProcessBuilder('./gradlew', ':turbotax-refund-aggregation-service:bootRun')
        processBuilder.directory(file('.'))
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/turbotax-refund-aggregation-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/turbotax-refund-aggregation-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-refund-aggregation-service in background (PID: ${process.pid()})"
        println "Service available at http://localhost:7002"
        println "Logs: logs/turbotax-refund-aggregation-service.log"
    }
}

task startRefundQueryService {
    group = 'services'
    description = 'Starts turbotax-refund-query-service in background (detached)'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        def processBuilder = new ProcessBuilder('./gradlew', ':turbotax-refund-query-service:bootRun')
        processBuilder.directory(file('.'))
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/turbotax-refund-query-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/turbotax-refund-query-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-refund-query-service in background (PID: ${process.pid()})"
        println "Service available at http://localhost:8001"
        println "Logs: logs/turbotax-refund-query-service.log"
    }
}

task startAgentService {
    group = 'services'
    description = 'Starts turbotax-agent-service in background (detached)'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        def processBuilder = new ProcessBuilder('./venv/bin/uvicorn', 'turbotax.agent.main:app', '--host', '0.0.0.0', '--port', '9001', '--reload', '--reload-dir', 'src/main/python')
        processBuilder.directory(file('turbotax-agent-service'))
        processBuilder.environment().put("PYTHONPATH", "src/main/python")
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/turbotax-agent-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/turbotax-agent-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-agent-service in background (PID: ${process.pid()})"
        println "Service available at http://localhost:9001"
        println "Logs: logs/turbotax-agent-service.log"
    }
}

// Stop individual services
task stopFilingQueryService {
    group = 'services'
    description = 'Stops turbotax-filing-query-service'
    
    doLast {
        try {
            exec {
                commandLine 'bash', '-c', "lsof -ti:7001 | xargs -r kill"
                ignoreExitValue = true
            }
            println "Stopped turbotax-filing-query-service (port 7001)"
        } catch (Exception e) {
            println "No turbotax-filing-query-service found running on port 7001"
        }
    }
}

task stopRefundAggregationService {
    group = 'services'
    description = 'Stops turbotax-refund-aggregation-service'
    
    doLast {
        try {
            exec {
                commandLine 'bash', '-c', "lsof -ti:7002 | xargs -r kill"
                ignoreExitValue = true
            }
            println "Stopped turbotax-refund-aggregation-service (port 7002)"
        } catch (Exception e) {
            println "No turbotax-refund-aggregation-service found running on port 7002"
        }
    }
}

task stopRefundQueryService {
    group = 'services'
    description = 'Stops turbotax-refund-query-service'
    
    doLast {
        try {
            exec {
                commandLine 'bash', '-c', "lsof -ti:8001 | xargs -r kill"
                ignoreExitValue = true
            }
            println "Stopped turbotax-refund-query-service (port 8001)"
        } catch (Exception e) {
            println "No turbotax-refund-query-service found running on port 8001"
        }
    }
}

task stopAgentService {
    group = 'services'
    description = 'Stops turbotax-agent-service'
    
    doLast {
        try {
            exec {
                commandLine 'bash', '-c', "lsof -ti:9001 | xargs -r kill"
                ignoreExitValue = true
            }
            println "Stopped turbotax-agent-service (port 9001)"
        } catch (Exception e) {
            println "No turbotax-agent-service found running on port 9001"
        }
    }
}

// Restart individual services
task restartFilingQueryService {
    group = 'services'
    description = 'Restarts turbotax-filing-query-service'
    
    dependsOn stopFilingQueryService, startFilingQueryService
    
    doLast {
        println "Restarted turbotax-filing-query-service"
    }
}

task restartRefundAggregationService {
    group = 'services'
    description = 'Restarts turbotax-refund-aggregation-service'
    
    dependsOn stopRefundAggregationService, startRefundAggregationService
    
    doLast {
        println "Restarted turbotax-refund-aggregation-service"
    }
}

task restartRefundQueryService {
    group = 'services'
    description = 'Restarts turbotax-refund-query-service'
    
    dependsOn stopRefundQueryService, startRefundQueryService
    
    doLast {
        println "Restarted turbotax-refund-query-service"
    }
}

task restartAgentService {
    group = 'services'
    description = 'Restarts turbotax-agent-service'
    
    dependsOn stopAgentService, startAgentService
    
    doLast {
        println "Restarted turbotax-agent-service"
    }
}

// Individual service status checks
task statusFilingQueryService {
    group = 'services'
    description = 'Checks status of turbotax-filing-query-service'
    
    doLast {
        try {
            def process = ['curl', '-s', 'http://localhost:7001/actuator/health'].execute()
            process.waitFor()
            if (process.exitValue() == 0) {
                println "✅ Filing Query Service: RUNNING (port 7001)"
            } else {
                println "❌ Filing Query Service: DOWN (port 7001)"
            }
        } catch (Exception e) {
            println "❌ Filing Query Service: DOWN (port 7001)"
        }
    }
}

task statusRefundAggregationService {
    group = 'services'
    description = 'Checks status of turbotax-refund-aggregation-service'
    
    doLast {
        try {
            def process = ['curl', '-s', 'http://localhost:7002/actuator/health'].execute()
            process.waitFor()
            if (process.exitValue() == 0) {
                println "✅ Refund Aggregation Service: RUNNING (port 7002)"
            } else {
                println "❌ Refund Aggregation Service: DOWN (port 7002)"
            }
        } catch (Exception e) {
            println "❌ Refund Aggregation Service: DOWN (port 7002)"
        }
    }
}

task statusRefundQueryService {
    group = 'services'
    description = 'Checks status of turbotax-refund-query-service'
    
    doLast {
        try {
            def process = ['curl', '-s', 'http://localhost:8001/actuator/health'].execute()
            process.waitFor()
            if (process.exitValue() == 0) {
                println "✅ Refund Query Service: RUNNING (port 8001)"
            } else {
                println "❌ Refund Query Service: DOWN (port 8001)"
            }
        } catch (Exception e) {
            println "❌ Refund Query Service: DOWN (port 8001)"
        }
    }
}

task statusAgentService {
    group = 'services'
    description = 'Checks status of turbotax-agent-service'
    
    doLast {
        try {
            def process = ['curl', '-s', 'http://localhost:9001/health'].execute()
            process.waitFor()
            if (process.exitValue() == 0) {
                println "✅ Agent Service: RUNNING (port 9001)"
            } else {
                println "❌ Agent Service: DOWN (port 9001)"
            }
        } catch (Exception e) {
            println "❌ Agent Service: DOWN (port 9001)"
        }
    }
}

// Bulk service management tasks
task startAllServices {
    group = 'services'
    description = 'Starts all TurboTax microservices in background'
    
    dependsOn startFilingQueryService, startRefundAggregationService, startRefundQueryService, startAgentService
    
    doLast {
        println ""
        println "=== All TurboTax Services Started ==="
        println "Filing Query Service: http://localhost:7001"        
        println "Refund Aggregation Service: http://localhost:7002"
        println "Refund Query Service: http://localhost:8001"
        println "Agent Service: http://localhost:9001"
        println ""
        println "Check logs for startup status."
        println "Use './gradlew stopAllServices' to stop all services."
    }
}

task stopAllServices {
    group = 'services'
    description = 'Stops all TurboTax microservices'
    
    dependsOn stopFilingQueryService, stopRefundAggregationService, stopRefundQueryService, stopAgentService
    
    doLast {
        // Also stop gradle daemons
        try {
            exec {
                commandLine './gradlew', '--stop'
                ignoreExitValue = true
            }
        } catch (Exception e) {
            // Ignore
        }
        
        println "All services stopped and Gradle daemons terminated."
    }
}

task restartAllServices {
    group = 'services'
    description = 'Restarts all TurboTax microservices'
    
    dependsOn stopAllServices, startAllServices
    
    doLast {
        println ""
        println "=== All TurboTax Services Restarted ==="
        println "Filing Query Service: http://localhost:7001"        
        println "Refund Aggregation Service: http://localhost:7002"
        println "Refund Query Service: http://localhost:8001"
        println "Agent Service: http://localhost:9001"
        println ""
    }
}

task statusAllServices {
    group = 'services'
    description = 'Checks status of all TurboTax microservices'
    
    dependsOn statusFilingQueryService, statusRefundAggregationService, statusRefundQueryService, statusAgentService
    
    doLast {
        println ""
        println "=== Service Status Summary ==="
        println "Use individual 'status<ServiceName>' tasks for detailed status."
    }
}

// Legacy task compatibility (keep existing task names)
task FilingQueryServiceBackground {
    group = 'services'
    description = 'Legacy: Runs turbotax-filing-query-service in background'
    dependsOn startFilingQueryService
}

// Stop services task (legacy)
task stopServices {
    group = 'services'
    description = 'Legacy: Stops all background Gradle daemon processes'
    
    doLast {
        println "Use './gradlew stopAllServices' instead of this legacy task."
        exec {
            commandLine './gradlew', 'stopAllServices'
        }
    }
}