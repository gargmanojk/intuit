// Root build.gradle for TurboTax services

// Individual service tasks
task FilingQueryService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-filing-query-service in background'
    
    commandLine './gradlew', ':turbotax-filing-query-service:bootRun'
    
    doLast {
        println "Started turbotax-filing-query-service"
        println "Service available at http://localhost:7001"
    }
}

task runRefundAggregationService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-refund-aggregation-service in background'
    
    commandLine './gradlew', ':turbotax-refund-aggregation-service:bootRun'
    
    doLast {
        println "Started turbotax-refund-aggregation-service"
        println "Service available at http://localhost:7002"
    }
}

task runRefundQueryService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-refund-query-service in background'
    
    commandLine './gradlew', ':turbotax-refund-query-service:bootRun'
    
    doLast {
        println "Started turbotax-refund-query-service"
        println "Service available at http://localhost:8001"
    }
}

task runAgentUIService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-agent-ui (combined agent + web UI) in background'

    workingDir 'turbotax-agent-ui'
    commandLine './venv/bin/uvicorn', 'turbotax.agent_ui.main:app', '--host', '0.0.0.0', '--port', '8080', '--reload', '--reload-dir', 'src/main/python'

    doLast {
        println "Started turbotax-agent-ui"
        println "Service available at http://localhost:8080"
        println "Web UI available at http://localhost:8080/web"
    }
}

task runAgentService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-agent-service (core AI service) in background'

    workingDir 'turbotax-agent-service'
    environment 'PYTHONPATH', 'src/main/python'
    commandLine './venv/bin/python', '-m', 'turbotax.agent_service.main'

    doLast {
        println "Started turbotax-agent-service"
        println "Service available at http://localhost:8000"
    }
}



// Background service tasks (using ProcessBuilder for true background execution)
task startFilingQueryService {
    group = 'services'
    description = 'Starts turbotax-filing-query-service in background (detached) with debug enabled'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        // Build the service first
        exec {
            commandLine './gradlew', ':turbotax-filing-query-service:build', '-x', 'test'
        }
        
        // Run the JAR with debug enabled
        def processBuilder = new ProcessBuilder(
            'java', 
            '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005',
            '-jar', 
            'turbotax-filing-query-service/build/libs/turbotax-filing-query-service-1.0.0-SNAPSHOT.jar'
        )
        processBuilder.directory(file('.'))
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/turbotax-filing-query-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/turbotax-filing-query-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-filing-query-service in background with debug enabled (PID: ${process.pid()})"
        println "Service available at http://localhost:7001"
        println "Debug port: 5005"
        println "Logs: logs/turbotax-filing-query-service.log"
    }
}

task startRefundAggregationService {
    group = 'services'
    description = 'Starts turbotax-refund-aggregation-service in background (detached) with debug enabled'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        // Build the service first
        exec {
            commandLine './gradlew', ':turbotax-refund-aggregation-service:build', '-x', 'test'
        }
        
        // Run the JAR with debug enabled
        def processBuilder = new ProcessBuilder(
            'java', 
            '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5006',
            '-jar', 
            'turbotax-refund-aggregation-service/build/libs/turbotax-refund-aggregation-service-1.0.0-SNAPSHOT.jar'
        )
        processBuilder.directory(file('.'))
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/turbotax-refund-aggregation-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/turbotax-refund-aggregation-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-refund-aggregation-service in background with debug enabled (PID: ${process.pid()})"
        println "Service available at http://localhost:7002"
        println "Debug port: 5006"
        println "Logs: logs/turbotax-refund-aggregation-service.log"
    }
}

task startRefundQueryService {
    group = 'services'
    description = 'Starts turbotax-refund-query-service in background (detached) with debug enabled'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        // Build the service first
        exec {
            commandLine './gradlew', ':turbotax-refund-query-service:build', '-x', 'test'
        }
        
        // Run the JAR with debug enabled
        def processBuilder = new ProcessBuilder(
            'java', 
            '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5007',
            '-jar', 
            'turbotax-refund-query-service/build/libs/turbotax-refund-query-service-1.0.0-SNAPSHOT.jar'
        )
        processBuilder.directory(file('.'))
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/turbotax-refund-query-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/turbotax-refund-query-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-refund-query-service in background with debug enabled (PID: ${process.pid()})"
        println "Service available at http://localhost:7000"
        println "Debug port: 5007"
        println "Logs: logs/turbotax-refund-query-service.log"
    }
}


task startAgentUIService {
    group = 'services'
    description = 'Starts turbotax-agent-ui (combined) in background (detached)'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        def processBuilder = new ProcessBuilder('./venv/bin/uvicorn', 'turbotax.agent_ui.main:app', '--host', '0.0.0.0', '--port', '8080', '--reload', '--reload-dir', 'src/main/python')
        processBuilder.directory(file('turbotax-agent-ui'))
        processBuilder.environment().put("PYTHONPATH", "src/main/python")
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/turbotax-agent-ui.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/turbotax-agent-ui-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-agent-ui in background (PID: ${process.pid()})"
        println "Service available at http://localhost:8080"
        println "Web UI available at http://localhost:8080/web"
        println "Logs: logs/turbotax-agent-ui.log"
    }
}

task startAgentService {
    group = 'services'
    description = 'Starts turbotax-agent-service (core AI service) in background (detached)'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        def processBuilder = new ProcessBuilder('./venv/bin/python', '-m', 'turbotax.agent_service.main')
        processBuilder.directory(file('turbotax-agent-service'))
        processBuilder.environment().put("PYTHONPATH", "src/main/python")
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/turbotax-agent-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/turbotax-agent-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-agent-service in background (PID: ${process.pid()})"
        println "Service available at http://localhost:8000"
        println "Logs: logs/turbotax-agent-service.log"
    }
}

// Stop individual services
task stopFilingQueryService {
    group = 'services'
    description = 'Stops turbotax-filing-query-service'
    
    doLast {
        try {
            exec {
                commandLine 'bash', '-c', "lsof -ti:7001 | xargs -r kill"
                ignoreExitValue = true
            }
            println "Stopped turbotax-filing-query-service (port 7001)"
        } catch (Exception e) {
            println "No turbotax-filing-query-service found running on port 7001"
        }
    }
}

task stopRefundAggregationService {
    group = 'services'
    description = 'Stops turbotax-refund-aggregation-service'
    
    doLast {
        try {
            exec {
                commandLine 'bash', '-c', "lsof -ti:7002 | xargs -r kill"
                ignoreExitValue = true
            }
            println "Stopped turbotax-refund-aggregation-service (port 7002)"
        } catch (Exception e) {
            println "No turbotax-refund-aggregation-service found running on port 7002"
        }
    }
}

task stopRefundQueryService {
    group = 'services'
    description = 'Stops turbotax-refund-query-service'
    
    doLast {
        try {
            exec {
                commandLine 'bash', '-c', "lsof -ti:7000 | xargs -r kill"
                ignoreExitValue = true
            }
            println "Stopped turbotax-refund-query-service (port 7000)"
        } catch (Exception e) {
            println "No turbotax-refund-query-service found running on port 7000"
        }
    }
}


task stopAgentUIService {
    group = 'services'
    description = 'Stops turbotax-agent-ui'
    
    doLast {
        try {
            exec {
                commandLine 'bash', '-c', "lsof -ti:8080 | xargs -r kill"
                ignoreExitValue = true
            }
            println "Stopped turbotax-agent-ui (port 8080)"
        } catch (Exception e) {
            println "No turbotax-agent-ui found running on port 8080"
        }
    }
}

task stopAgentService {
    group = 'services'
    description = 'Stops turbotax-agent-service'
    
    doLast {
        try {
            exec {
                commandLine 'bash', '-c', "lsof -ti:8000 | xargs -r kill"
                ignoreExitValue = true
            }
            println "Stopped turbotax-agent-service (port 8000)"
        } catch (Exception e) {
            println "No turbotax-agent-service found running on port 8000"
        }
    }
}

// Restart individual services
task restartFilingQueryService {
    group = 'services'
    description = 'Restarts turbotax-filing-query-service'
    
    dependsOn stopFilingQueryService, startFilingQueryService
    
    doLast {
        println "Restarted turbotax-filing-query-service"
    }
}

task restartRefundAggregationService {
    group = 'services'
    description = 'Restarts turbotax-refund-aggregation-service'
    
    dependsOn stopRefundAggregationService, startRefundAggregationService
    
    doLast {
        println "Restarted turbotax-refund-aggregation-service"
    }
}

task restartRefundQueryService {
    group = 'services'
    description = 'Restarts turbotax-refund-query-service'
    
    dependsOn stopRefundQueryService, startRefundQueryService
    
    doLast {
        println "Restarted turbotax-refund-query-service"
    }
}

task restartAgentUIService {
    group = 'services'
    description = 'Restarts turbotax-agent-ui'
    
    dependsOn stopAgentUIService, startAgentUIService
    
    doLast {
        println "Restarted turbotax-agent-ui"
    }
}

task restartAgentService {
    group = 'services'
    description = 'Restarts turbotax-agent-service'
    
    dependsOn stopAgentService, startAgentService
    
    doLast {
        println "Restarted turbotax-agent-service"
    }
}

// Individual service status checks
task statusFilingQueryService {
    group = 'services'
    description = 'Checks status of turbotax-filing-query-service'
    
    doLast {
        try {
            def process = ['curl', '-s', 'http://localhost:7001/actuator/health'].execute()
            process.waitFor()
            if (process.exitValue() == 0) {
                println "✅ Filing Query Service: RUNNING (port 7001)"
            } else {
                println "❌ Filing Query Service: DOWN (port 7001)"
            }
        } catch (Exception e) {
            println "❌ Filing Query Service: DOWN (port 7001)"
        }
    }
}

task statusRefundAggregationService {
    group = 'services'
    description = 'Checks status of turbotax-refund-aggregation-service'
    
    doLast {
        try {
            def process = ['curl', '-s', 'http://localhost:7002/actuator/health'].execute()
            process.waitFor()
            if (process.exitValue() == 0) {
                println "✅ Refund Aggregation Service: RUNNING (port 7002)"
            } else {
                println "❌ Refund Aggregation Service: DOWN (port 7002)"
            }
        } catch (Exception e) {
            println "❌ Refund Aggregation Service: DOWN (port 7002)"
        }
    }
}

task statusRefundQueryService {
    group = 'services'
    description = 'Checks status of turbotax-refund-query-service'
    
    doLast {
        try {
            def process = ['curl', '-s', 'http://localhost:7000/actuator/health'].execute()
            process.waitFor()
            if (process.exitValue() == 0) {
                println "✅ Refund Query Service: RUNNING (port 7000)"
            } else {
                println "❌ Refund Query Service: DOWN (port 7000)"
            }
        } catch (Exception e) {
            println "❌ Refund Query Service: DOWN (port 7000)"
        }
    }
}

task statusAgentUIService {
    group = 'services'
    description = 'Checks status of turbotax-agent-ui'
    
    doLast {
        try {
            def process = ['curl', '-s', 'http://localhost:8080/health'].execute()
            process.waitFor()
            if (process.exitValue() == 0) {
                println "✅ Agent UI Service: RUNNING (port 8080)"
            } else {
                println "❌ Agent UI Service: DOWN (port 8080)"
            }
        } catch (Exception e) {
            println "❌ Agent UI Service: DOWN (port 8080)"
        }
    }
}

task statusAgentService {
    group = 'services'
    description = 'Checks status of turbotax-agent-service'
    
    doLast {
        try {
            def process = ['curl', '-s', 'http://localhost:8000/health'].execute()
            process.waitFor()
            if (process.exitValue() == 0) {
                println "✅ Agent Service: RUNNING (port 8000)"
            } else {
                println "❌ Agent Service: DOWN (port 8000)"
            }
        } catch (Exception e) {
            println "❌ Agent Service: DOWN (port 8000)"
        }
    }
}

// Bulk service management tasks
task startAllServices {
    group = 'services'
    description = 'Starts all TurboTax microservices in background with debug enabled'
    
    dependsOn startFilingQueryService, startRefundAggregationService, startRefundQueryService, startAgentService, startAgentUIService
    
    doLast {
        println ""
        println "=== All TurboTax Services Started (with debug enabled) ==="
        println "Filing Query Service: http://localhost:7001 (debug port: 5005)"        
        println "Refund Aggregation Service: http://localhost:7002 (debug port: 5006)"
        println "Refund Query Service: http://localhost:7000 (debug port: 5007)"
        println "Agent Service: http://localhost:8000"
        println "Agent UI (Combined): http://localhost:8080"
        println ""
        println "Check logs for startup status."
        println "Use './gradlew stopAllServices' to stop all services."
        println "Use VS Code debug configurations to attach debugger to Java services."
    }
}

task stopAllServices {
    group = 'services'
    description = 'Stops all TurboTax microservices'
    
    dependsOn stopFilingQueryService, stopRefundAggregationService, stopRefundQueryService, stopAgentUIService, stopAgentService
    
    doLast {
        // Also stop gradle daemons
        try {
            exec {
                commandLine './gradlew', '--stop'
                ignoreExitValue = true
            }
        } catch (Exception e) {
            // Ignore
        }
        
        println "All services stopped and Gradle daemons terminated."
    }
}

task restartAllServices {
    group = 'services'
    description = 'Restarts all TurboTax microservices with debug enabled'
    
    dependsOn stopAllServices, startAllServices
    
    doLast {
        println ""
        println "=== All TurboTax Services Restarted (with debug enabled) ==="
        println "Filing Query Service: http://localhost:7001 (debug port: 5005)"        
        println "Refund Aggregation Service: http://localhost:7002 (debug port: 5006)"
        println "Refund Query Service: http://localhost:7000 (debug port: 5007)"
        println "Agent Service: http://localhost:8000"
        println "Agent UI (Combined): http://localhost:8080"
        println ""
    }
}

task statusAllServices {
    group = 'services'
    description = 'Checks status of all TurboTax microservices'
    
    dependsOn statusFilingQueryService, statusRefundAggregationService, statusRefundQueryService, statusAgentUIService, statusAgentService
    
    doLast {
        println ""
        println "=== Service Status Summary ==="
        println "Use individual 'status<ServiceName>' tasks for detailed status."
    }
}

// Legacy task compatibility (keep existing task names)
task FilingQueryServiceBackground {
    group = 'services'
    description = 'Legacy: Runs turbotax-filing-query-service in background'
    dependsOn startFilingQueryService
}

// Stop services task (legacy)
task stopServices {
    group = 'services'
    description = 'Legacy: Stops all background Gradle daemon processes'
    
    doLast {
        println "Use './gradlew stopAllServices' instead of this legacy task."
        exec {
            commandLine './gradlew', 'stopAllServices'
        }
    }
}