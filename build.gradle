// Root build.gradle for TurboTax services

// Individual service tasks
task runFilingDataService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-filing-data-service in background'
    
    commandLine './gradlew', ':turbotax-filing-data-service:bootRun'
    
    doLast {
        println "Started turbotax-filing-data-service"
        println "Service available at http://localhost:7001"
    }
}

task runRefundAggregationService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-refund-aggregation-service in background'
    
    commandLine './gradlew', ':turbotax-refund-aggregation-service:bootRun'
    
    doLast {
        println "Started turbotax-refund-aggregation-service"
        println "Service available at http://localhost:7002"
    }
}

task runRefundPredictionService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-refund-prediction-service in background'
    
    commandLine './gradlew', ':turbotax-refund-prediction-service:bootRun'
    
    doLast {
        println "Started turbotax-refund-prediction-service"
        println "Service available at http://localhost:7003"
    }
}

task runRefundQueryService(type: Exec) {
    group = 'services'
    description = 'Runs turbotax-refund-query-service in background'
    
    commandLine './gradlew', ':turbotax-refund-query-service:bootRun'
    
    doLast {
        println "Started turbotax-refund-query-service"
        println "Service available at http://localhost:8001"
    }
}


// Background service tasks (using ProcessBuilder for true background execution)
task startFilingDataService {
    group = 'services'
    description = 'Starts turbotax-filing-data-service in background (detached)'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        def processBuilder = new ProcessBuilder('./gradlew', ':turbotax-filing-data-service:bootRun')
        processBuilder.directory(file('.'))
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/filing-data-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/filing-data-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-filing-data-service in background (PID: ${process.pid()})"
        println "Service available at http://localhost:7001"
        println "Logs: logs/filing-data-service.log"
    }
}

task startRefundAggregationService {
    group = 'services'
    description = 'Starts turbotax-refund-aggregation-service in background (detached)'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        def processBuilder = new ProcessBuilder('./gradlew', ':turbotax-refund-aggregation-service:bootRun')
        processBuilder.directory(file('.'))
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/refund-aggregation-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/refund-aggregation-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-refund-aggregation-service in background (PID: ${process.pid()})"
        println "Service available at http://localhost:7002"
        println "Logs: logs/refund-aggregation-service.log"
    }
}

task startRefundPredictionService {
    group = 'services'
    description = 'Starts turbotax-refund-prediction-service in background (detached)'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        def processBuilder = new ProcessBuilder('./gradlew', ':turbotax-refund-prediction-service:bootRun')
        processBuilder.directory(file('.'))
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/refund-prediction-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/refund-prediction-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-refund-prediction-service in background (PID: ${process.pid()})"
        println "Service available at http://localhost:7003"
        println "Logs: logs/refund-prediction-service.log"
    }
}

task startRefundQueryService {
    group = 'services'
    description = 'Starts turbotax-refund-query-service in background (detached)'
    
    doLast {
        // Ensure logs directory exists
        def logsDir = new File('logs')
        if (!logsDir.exists()) {
            logsDir.mkdirs()
        }
        
        def processBuilder = new ProcessBuilder('./gradlew', ':turbotax-refund-query-service:bootRun')
        processBuilder.directory(file('.'))
        processBuilder.redirectOutput(ProcessBuilder.Redirect.to(new File('logs/refund-query-service.log')))
        processBuilder.redirectError(ProcessBuilder.Redirect.to(new File('logs/refund-query-service-error.log')))
        
        def process = processBuilder.start()
        println "Started turbotax-refund-query-service in background (PID: ${process.pid()})"
        println "Service available at http://localhost:8001"
        println "Logs: logs/refund-query-service.log"
    }
}

// Start all services at once
task startAllServices {
    group = 'services'
    description = 'Starts all TurboTax microservices in background'
    
    dependsOn startFilingDataService, startRefundAggregationService, startRefundPredictionService, startRefundQueryService
    
    doLast {
        println ""
        println "=== All TurboTax Services Started ==="
        println "Filing Data Service: http://localhost:7001"        
        println "Refund Aggregation Service: http://localhost:7002"
        println "Refund Prediction Service: http://localhost:7003"
        println "Refund Query Service: http://localhost:8001"
        println ""
        println "Check logs for startup status."
        println "Use './gradlew stopAllServices' to stop all services."
    }
}

// Stop all services
task stopAllServices {
    group = 'services'
    description = 'Stops all TurboTax microservices'
    
    doLast {
        def ports = [7001, 7002, 7003, 8001]
        
        ports.each { port ->
            try {
                exec {
                    commandLine 'bash', '-c', "lsof -ti:${port} | xargs -r kill"
                    ignoreExitValue = true
                }
                println "Stopped service on port ${port}"
            } catch (Exception e) {
                println "No service found on port ${port}"
            }
        }
        
        // Also stop gradle daemons
        try {
            exec {
                commandLine './gradlew', '--stop'
                ignoreExitValue = true
            }
        } catch (Exception e) {
            // Ignore
        }
        
        println "All services stopped and Gradle daemons terminated."
    }
}

// Health check task
task checkAllServices {
    group = 'services'
    description = 'Checks health of all TurboTax microservices'
    
    doLast {
        def services = [
            'Filing Data': 'http://localhost:7001/actuator/health',            
            'Refund Aggregation': 'http://localhost:7002/actuator/health',
            'Refund Prediction': 'http://localhost:7003/actuator/health',
            'Refund Query': 'http://localhost:8001/actuator/health'
        ]
        
        println "=== Service Health Check ==="
        
        services.each { name, url ->
            try {
                def process = ['curl', '-s', url].execute()
                process.waitFor()
                if (process.exitValue() == 0) {
                    println "✅ ${name} Service: HEALTHY"
                } else {
                    println "❌ ${name} Service: DOWN"
                }
            } catch (Exception e) {
                println "❌ ${name} Service: DOWN"
            }
        }
    }
}

// Legacy task compatibility (keep existing task names)
task runFilingDataServiceBackground {
    group = 'services'
    description = 'Legacy: Runs turbotax-filing-data-service in background'
    dependsOn startFilingDataService
}

// Stop services task (legacy)
task stopServices {
    group = 'services'
    description = 'Legacy: Stops all background Gradle daemon processes'
    dependsOn stopAllServices
}